<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <LinuxAMD64BuildDir>linux-x64</LinuxAMD64BuildDir>
    <LinuxARM64BuildDir>linux-arm64</LinuxARM64BuildDir>
    <LinuxBinaryLibraryPath64>lib64/liblua55.so</LinuxBinaryLibraryPath64>
    <OuputLinuxLibraryAMD64>$(OutputRuntimeDir)\$(LinuxAMD64BuildDir)\native\liblua55.so</OuputLinuxLibraryAMD64>
    <OuputLinuxLibraryARM64>$(OutputRuntimeDir)\$(LinuxARM64BuildDir)\native\liblua55.so</OuputLinuxLibraryARM64>
  </PropertyGroup>
  <Target Name="BuildLuaLinux" BeforeTargets="BeforeBuild" Condition="'$(OS)'=='Unix' and !Exists('/usr/bin/xcodebuild') and !Exists('$(OuputLinuxLibraryAMD64)')" >
    <Message Text="Building Linux Lua library (x64)" />
    <Exec Command="export CFLAGS=-m64" WorkingDirectory="$(ExternalLuaPath)" Condition="!Exists('$(ExternalLuaPath)\$(LinuxAMD64BuildDir)')" />
    <Exec Command="export LDFLAGS=-m64" WorkingDirectory="$(ExternalLuaPath)" Condition="!Exists('$(ExternalLuaPath)\$(LinuxAMD64BuildDir)')" />
    <Exec Command="mkdir $(ExternalLuaPath)\$(LinuxAMD64BuildDir)" WorkingDirectory="$(ExternalLuaPath)" Condition="!Exists('$(ExternalLuaPath)\$(LinuxAMD64BuildDir)')" />
    <Exec Command="cmake $(ExternalLuaPath) -DCMAKE_BUILD_TYPE=Release" WorkingDirectory="$(ExternalLuaPath)\$(LinuxAMD64BuildDir)" Condition="!Exists('$(ExternalLuaPath)\$(LinuxAMD64BuildDir)\CMakeCache.txt')" />
    <Exec Command="cmake --build . --config Release" WorkingDirectory="$(ExternalLuaPath)\$(LinuxAMD64BuildDir)" />
    <Exec Command="strip -s $(ExternalLuaPath)\$(LinuxAMD64BuildDir)\$(LinuxBinaryLibraryPath64)" WorkingDirectory="$(ExternalLuaPath)\$(LinuxAMD64BuildDir)" />
    <Copy SourceFiles="$(ExternalLuaPath)\$(LinuxAMD64BuildDir)\$(LinuxBinaryLibraryPath64)" DestinationFolder="$(OutputRuntimeDir)\$(LinuxAMD64BuildDir)\native" SkipUnchangedFiles="true" />
  </Target>
  <Target Name="BuildLuaLinuxARM64" AfterTargets="BuildLuaLinux" Condition="'$(OS)'=='Unix' and !Exists('/usr/bin/xcodebuild') and Exists('/usr/bin/aarch64-linux-gnu-gcc-9')  and !Exists('$(OuputLinuxLibraryARM64)')" >
    <Message Text="Building Linux Lua library (arm64)" />
    <Exec Command="export CXXFLAGS=-march=armv8-a" WorkingDirectory="$(ExternalLuaPath)" Condition="!Exists('$(ExternalLuaPath)\$(LinuxARM64BuildDir)')" />
    <Exec Command="export CFLAGS=-march=armv8-a" WorkingDirectory="$(ExternalLuaPath)" Condition="!Exists('$(ExternalLuaPath)\$(LinuxARM64BuildDir)')" />
    <Exec Command="export LDFLAGS=-march=armv8-a" WorkingDirectory="$(ExternalLuaPath)" Condition="!Exists('$(ExternalLuaPath)\$(LinuxARM64BuildDir)')" />
    <Exec Command="mkdir $(ExternalLuaPath)\$(LinuxARM64BuildDir)" WorkingDirectory="$(ExternalLuaPath)" Condition="!Exists('$(ExternalLuaPath)\$(LinuxARM64BuildDir)')" />
    <Exec Command="cmake $(ExternalLuaPath) -DCMAKE_BUILD_TYPE=Release -DCMAKE_CROSSCOMPILING=TRUE -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER -DCMAKE_SYSTEM_PROCESSOR=aarch64 -DCMAKE_SYSTEM_NAME=Linux -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++-9 -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc-9" WorkingDirectory="$(ExternalLuaPath)\$(LinuxARM64BuildDir)" 
          Condition="!Exists('$(ExternalLuaPath)\$(LinuxARM64BuildDir)\CMakeCache.txt')" />
    <Exec Command="cmake --build . --config Release" WorkingDirectory="$(ExternalLuaPath)\$(LinuxARM64BuildDir)" />
    <Exec Command="/usr/aarch64-linux-gnu/bin/strip -s $(ExternalLuaPath)\$(LinuxARM64BuildDir)\$(LinuxBinaryLibraryPath64)" WorkingDirectory="$(ExternalLuaPath)\$(LinuxARM64BuildDir)" />
    <Copy SourceFiles="$(ExternalLuaPath)\$(LinuxARM64BuildDir)\$(LinuxBinaryLibraryPath64)" DestinationFolder="$(OutputRuntimeDir)\$(LinuxARM64BuildDir)\native" SkipUnchangedFiles="true" Condition="Exists('/usr/bin/aarch64-linux-gnu-gcc-9')" />
    <Exec Command="unset CXXFLAGS" WorkingDirectory="$(ExternalLuaPath)" Condition="!Exists('$(ExternalLuaPath)\$(LinuxARM64BuildDir)')" />
    <Exec Command="unset CFLAGS" WorkingDirectory="$(ExternalLuaPath)" Condition="!Exists('$(ExternalLuaPath)\$(LinuxARM64BuildDir)')" />
    <Exec Command="unset LDFLAGS" WorkingDirectory="$(ExternalLuaPath)" Condition="!Exists('$(ExternalLuaPath)\$(LinuxARM64BuildDir)')" />
  </Target>
  <Target Name="MessageSkipBuildLuaLinuxARM64" AfterTargets="BuildLuaLinuxARM64" Condition="'$(OS)'=='Unix' and !Exists('/usr/bin/xcodebuild') and !Exists('/usr/bin/aarch64-linux-gnu-gcc-9')">
      <Message Text="Skipping Linux ARM64 build - /usr/bin/aarch64-linux-gnu-gcc-9 not found " />
  </Target>
  <Target Name="CleanLuaLinux" AfterTargets="Clean" Condition="'$(OS)'=='Unix' and !Exists('/usr/bin/xcodebuild')">
      <Message Text="Cleaning Lua library (x64)" />
      <RemoveDir Directories="$(ExternalLuaPath)\$(LinuxAMD64BuildDir); $(OutputRuntimeDir)\$(LinuxAMD64BuildDir) " />
      <RemoveDir Directories="$(ExternalLuaPath)\$(LinuxARM64BuildDir); $(OutputRuntimeDir)\$(LinuxARM64BuildDir) " />
  </Target>
</Project>