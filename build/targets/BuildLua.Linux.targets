<Project>
  <PropertyGroup>
    <Linux32BuildDir>linux-x86</Linux32BuildDir>
    <Linux64BuildDir>linux-x64</Linux64BuildDir>
    <BinaryLibraryPath32>bin\liblua53.so</BinaryLibraryPath32>
    <BinaryLibraryPath64>bin64\liblua53.so</BinaryLibraryPath64>
    <ExternalLuaPath>$([System.IO.Path]::GetFullPath($(ExternalLuaDir)))</ExternalLuaPath>
  </PropertyGroup>
  <Target Name="BuildLuaLinux" BeforeTargets="BeforeBuild" Condition="'$(OS)'=='Unix' and not $([System.IO.File]::Exists('/usr/lib/libc.dylib')">
    <Message Text="Building Linux Lua library (x86)" />
    <Exec Command="mkdir $(ExternalLuaPath)\$(Linux32BuildDir)" WorkingDirectory="$(ExternalLuaPath)" Condition="!Exists('$(ExternalLuaPath)\$(Linux32BuildDir)')" />
    <Exec Command="cmake $(ExternalLuaPath)" WorkingDirectory="$(ExternalLuaPath)\$(Linux32BuildDir)" Condition="!Exists('$(ExternalLuaPath)\$(Linux32BuildDir)\CMakeCache.txt')" />
    <Exec Command="cmake --build . --config Release" WorkingDirectory="$(ExternalLuaPath)\$(Linux32BuildDir)" />
    <Message Text="Building Linux Lua library (x64)" />
    <Exec Command="mkdir $(ExternalLuaPath)\$(Linux64BuildDir)" WorkingDirectory="$(ExternalLuaPath)" Condition="!Exists('$(ExternalLuaPath)\$(Linux64BuildDir)')" />
    <Exec Command="cmake $(ExternalLuaPath) -DCMAKE_GENERATOR_PLATFORM=x64" WorkingDirectory="$(ExternalLuaPath)\$(Linux64BuildDir)" Condition="!Exists('$(ExternalLuaPath)\$(Linux64BuildDir)\CMakeCache.txt')" />
    <Exec Command="cmake --build . --config Release" WorkingDirectory="$(ExternalLuaPath)\$(Linux64BuildDir)" />
    <Copy SourceFiles="$(ExternalLuaPath)\$(Linux64BuildDir)\$(BinaryLibraryPath32)" DestinationFolder="$(OutputRuntimeDir)\$(Linux64BuildDir)" SkipUnchangedFiles="true" />
    <Copy SourceFiles="$(ExternalLuaPath)\$(Linux64BuildDir)\$(BinaryLibraryPath64)" DestinationFolder="$(OutputRuntimeDir)\$(Linux64BuildDir)" SkipUnchangedFiles="true" />
  </Target>
  <Target Name="CleanLuaLinux" AfterTargets="Clean" Condition="'$(OS)'=='Unix' and not $([System.IO.File]::Exists('/usr/lib/libc.dylib')">
      <Message Text="Cleaning Lua library (x86/x64)" />
      <RemoveDir Directories="$(ExternalLuaPath)\$(Linux64BuildDir); $(OutputRuntimeDir)\$(Linux64BuildDir) " />
      <RemoveDir Directories="$(ExternalLuaPath)\$(Linux32BuildDir); $(OutputRuntimeDir)\$(Linux32BuildDir) " />
  </Target>
</Project>

